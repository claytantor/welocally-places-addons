function WELOCALLY_PlacesMultiWidget(a){this.map;this.map_canvas;this.searchLocation;this.cfg;this.options;this.placeMarkers=[];this.mapStatus;this.results;this.selectedSection;this.infoBox;this.boxText;this.selectedMarkerIndex;this.init=function(){var d=this.initCfg(a);var b=jQuery("SCRIPT");b=b[b.length-1];if(d){var c=jQuery("<div></div>");WELOCALLY.ui.setStatus(c,d,"wl_error");jQuery(b).parent().before(c)}else{this.wrapper=this.makeWrapper();jQuery(b).parent().before(this.wrapper)}return this}}WELOCALLY_PlacesMultiWidget.prototype.initCfg=function(a){var b=[];if(!a){b.push("Please provide configuration for the widget");a={}}if(!a.hidePlaceSectionMaps){a.hidePlaceSectionMap=true}if(!a.id){a.id=WELOCALLY.util.keyGenerator()}if(!a.endpoint){a.endpoint="https://api.welocally.com"}if(!a.baseUrl){a.baseUrl="http://placehound.com"}if(!a.imagePath){a.imagePath=a.baseUrl+"/images/marker_all_base.png"}if(a.showSelection==null){a.showSelection=true}if(!a.zoom){a.zoom=16}if(b.length>0){return b}this.cfg=a};WELOCALLY_PlacesMultiWidget.prototype.makeWrapper=function(){var a=this;var b=jQuery("<div></div>");jQuery(b).attr("class","wl_places_multi_widget");jQuery(b).attr("id","wl_places_multi_widget_"+a.cfg.id);this.selectedSection=jQuery('<div class="wl_places_multi_selected"></div>');jQuery(this.selectedSection).css("display","none");jQuery(b).append(this.selectedSection);this.map_canvas=document.createElement("DIV");jQuery(this.map_canvas).css("display","none");jQuery(this.map_canvas).attr("class","wl_places_multi_map_canvas");jQuery(this.map_canvas).attr("id","welocally_places_multi_map_canvas_"+a.cfg.id);jQuery(b).append(this.map_canvas);this.mapStatus=jQuery('<div class="wl_places_multi_map_status"></div>');jQuery(b).append(this.mapStatus);this.results=jQuery('<ol id="wl_places_mutli_selectable"></ol>');jQuery(this.results).css("display","none");jQuery(this.results).bind("selectableselected",{instance:this},this.selectedItemHandler);jQuery(b).append(this.results);if(this.cfg.places!=null&&this.cfg.places.length>0){this.setPlaces(this.cfg.places)}else{this.map=this.initMap(this.map_canvas)}jQuery(this.results).selectable({cancel:"a"});this.wrapper=b;return b};WELOCALLY_PlacesMultiWidget.prototype.setPlaces=function(b){var a=this;if(a.map==null){a.map=a.initMapForPlaces(a.cfg.places,a.map_canvas,a.placeMarkers)}else{a.deleteOverlays(a.placeMarkers);a.addPlaces(a.map,b,a.placeMarkers);a.setMapEvents(a.map,a.placeMarkers)}if(!a.cfg.hideMap){jQuery(a.map_canvas).show()}};WELOCALLY_PlacesMultiWidget.prototype.initMap=function(d){var a=this;var b={mapTypeId:google.maps.MapTypeId.ROADMAP,zoom:a.cfg.zoom};if(a.cfg.styles){b.styles=a.cfg.styles}var c=new google.maps.Map(d,b);a.boxText=document.createElement("div");a.boxText.className="wl_places_mutli_infobox";a.boxText.innerHTML="none selected";a.infoBox=this.makeInfoBox(a.boxText);return c};WELOCALLY_PlacesMultiWidget.prototype.initMapForPlaces=function(b,e,d){var a=this;var c=a.initMap(e);a.addPlaces(c,b,d);a.setMapEvents(c,d);return c};WELOCALLY_PlacesMultiWidget.prototype.makeInfoBox=function(c){var b=this;var d={content:c,disableAutoPan:false,maxWidth:0,pixelOffset:new google.maps.Size(0,5),zIndex:null,boxStyle:{opacity:0.85},closeBoxMargin:"2px 2px 2px 2px",closeBoxURL:b.cfg.imagePath,infoBoxClearance:new google.maps.Size(1,1),isHidden:false,pane:"floatPane",enableEventPropagation:false};var a=new WELOCALLY_InfoBox(d);return a};WELOCALLY_PlacesMultiWidget.prototype.addPlaces=function(e,c,f){var a=this;var d=new google.maps.LatLngBounds();a.deleteOverlays(a.placeMarkers);jQuery(a.results).empty();jQuery(a.results).hide();a.infoBox.close();jQuery.each(c,function(h,l){var n=new google.maps.LatLng(l.geometry.coordinates[1],l.geometry.coordinates[0]);d.extend(n);var j=new google.maps.LatLng(l.geometry.coordinates[1],l.geometry.coordinates[0]);var g=null;if(a.cfg.showLetters){var m=(3*32)+(32*h);g=new google.maps.MarkerImage(a.cfg.imagePath,new google.maps.Size(32,32),new google.maps.Point(m,0))}else{g=new google.maps.MarkerImage(a.cfg.imagePath,new google.maps.Size(32,32),new google.maps.Point(32,0))}a.addMarker(h,f,e,j,l,g);if(a.cfg.showSelection){var k=a.makeItemContents(l,h,true);if(a.cfg.overrideSelectableStyle){jQuery(k).attr("style",a.cfg.overrideSelectableStyle)}jQuery(k).attr("id","wl_places_mutli_selectable_"+h);jQuery(k).attr("class","ui-widget-content");jQuery(k).mouseover(function(){jQuery(this).css("cursor","pointer")});jQuery(a.results).append(jQuery(k));jQuery(a.results).show()}});e.fitBounds(a.makeMinimumBounds(d));var b=new google.maps.MarkerImage(a.cfg.imagePath,new google.maps.Size(32,32),new google.maps.Point(0,0));a.addMarkerCenter(f,e,d.getCenter(),b);setTimeout(function(){a.refreshMap(d.getCenter(),d)},100);setTimeout(function(){a.refreshMap(d.getCenter(),d)},200)};WELOCALLY_PlacesMultiWidget.prototype.makeMinimumBounds=function(b){var a=this;var e=a.getBoundsDistance(b);if(e<0.03){var d=new google.maps.LatLng(b.getCenter().lat()-0.002,b.getCenter().lng()-0.002);var c=new google.maps.LatLng(b.getCenter().lat()+0.002,b.getCenter().lng()+0.002);b.extend(d);b.extend(c)}return b};WELOCALLY_PlacesMultiWidget.prototype.makeItemContents=function(d,b,f){var a=this;var g=jQuery("<li></il>");if(a.cfg.showLetters&&f){var e=(3*32)+(32*b);var c=jQuery('<span class="wl_selectable_marker" style="display:block; width: 32px; height: 32px; background:url('+a.cfg.imagePath+") -"+e+'px 0px; background-repeat:no-repeat;" />');jQuery(g).append(c)}if(a.cfg.idLinks){jQuery(g).append('<a href="'+a.cfg.baseUrl+"/place.html?id="+d.id+'"><div class="selectable_title">'+d.properties.name+"</a></div>")}else{if(d.properties.titlelink!=null&&d.properties.titlelink!=""){jQuery(g).append('<a href="'+d.properties.titlelink+'"><div class="selectable_title">'+d.properties.name+"</a></div>")}else{jQuery(g).append('<div class="selectable_title">'+d.properties.name+"</div>")}}jQuery(g).append(jQuery('<div class="selectable_address">'+d.properties.address+" "+d.properties.city+" "+d.properties.province+"</div>"));if(d.distance&&!a.cfg.hideDistance){jQuery(g).append(jQuery('<div class="selectable_distance">'+d.distance.toFixed(2)+"km </div>"))}g.item=d;return g};WELOCALLY_PlacesMultiWidget.prototype.setMapEvents=function(c,d){var a=this;google.maps.event.addListener(c,"zoom_changed",function(){zoomChangeBoundsListener=google.maps.event.addListener(c,"bounds_changed",function(e){a.setStatus(a.mapStatus,a.makeMapStatus(a.map,a.placeMarkers),"wl_message",false)})});var b=google.maps.event.addListener(c,"tilesloaded",function(){a.setStatus(a.mapStatus,a.makeMapStatus(a.map,a.placeMarkers),"wl_message",false);google.maps.event.removeListener(b);WELOCALLY.util.preload(["http://maps.google.com/mapfiles/openhand.cur"])})},WELOCALLY_PlacesMultiWidget.prototype.selectedItemHandler=function(e,f){var b=null;var a;var c;if(this.nodeName=="OL"){b=e.data.instance;c=f.selected.id.replace("wl_places_mutli_selectable_","");a=b.placeMarkers[c];b.selectedPlace=b.placeMarkers[c].item}else{if(this.nodeName=="MARKER"){b=this.instance;a=this;c=a.index;jQuery("#wl_places_mutli_selectable_"+b.selectedMarkerIndex).removeClass("ui-selected");jQuery("#wl_places_mutli_selectable_"+c).addClass("ui-selected");b.selectedPlace=this.item}}b.selectedMarkerIndex=c;a.map.panTo(a.position);var d=b.makeItemContents(b.selectedPlace,0,false);jQuery(d).attr("class","wl_places_multi_infobox");jQuery(d).css("min-width","100px");jQuery(d).css("min-height","30px");jQuery(b.boxText).html(d);jQuery(b.boxText).find("li a img").load(function(){jQuery(b.boxText).find("li a").css("background","none").css("padding","0px");jQuery(b.boxText).css("line-height","5px");jQuery(b.boxText).find("ul").css("margin","0px")});b.infoBox.setOffset(d);b.infoBox.open(a.map,a);if(b!=null){if(b.cfg.observers!=null&&b.cfg.observers.length>0){jQuery.each(b.cfg.observers,function(g,h){h.show(b.selectedPlace)});jQuery(b.getSelectedArea()).show()}}};WELOCALLY_PlacesMultiWidget.prototype.resetOverlays=function(c,a){var b=this;b.map.setCenter(c);jQuery(b.map_canvas).show();jQuery(b.map).show();b.deleteOverlays(a);b.placeMarkers=[]};WELOCALLY_PlacesMultiWidget.prototype.refreshMap=function(e,c){var a=this;google.maps.event.trigger(a.map,"resize");if(a.placeMarkers.length==0){var b=new google.maps.MarkerImage(a.cfg.imagePath,new google.maps.Size(32,32),new google.maps.Point(0,0));a.addMarkerCenter(a.placeMarkers,a.map,e,b)}a.setStatus(a.mapStatus,a.makeMapStatus(a.map,a.placeMarkers),"wl_message",false);a.map.setCenter(e);if(c!=null){a.map.fitBounds(c)}var d=google.maps.event.addListener(a.map,"tilesloaded",function(){google.maps.event.removeListener(d);a.map.setCenter(e);a.setStatus(a.mapStatus,a.makeMapStatus(a.map,a.placeMarkers),"wl_message",false)})};WELOCALLY_PlacesMultiWidget.prototype.showOverlays=function(a,b){if(a){for(i in a){a[i].setMap(b)}}};WELOCALLY_PlacesMultiWidget.prototype.deleteOverlays=function(a){if(a){for(i in a){a[i].setMap(null)}a.length=0}};WELOCALLY_PlacesMultiWidget.prototype.colName=function(c){var a=this;var b="";while(c>=0){b=String.fromCharCode(c%26+65)+b;c=Math.floor(c/26)-1}return b};WELOCALLY_PlacesMultiWidget.prototype.addMarker=function(f,b,a,e,h,g){var d=this;var c=new google.maps.Marker({index:f,nodeName:"MARKER",instance:this,position:e,title:h.properties.name,map:a,icon:g,item:h});google.maps.event.addListener(c,"click",this.selectedItemHandler);b.push(c)};WELOCALLY_PlacesMultiWidget.prototype.addMarkerCenter=function(b,a,e,f){var d=this;var c=new google.maps.Marker({instance:this,position:e,map:a,icon:f});b.push(c)};WELOCALLY_PlacesMultiWidget.prototype.clearOverlays=function(a){if(a){for(i in a){a[i].setMap(null)}}};WELOCALLY_PlacesMultiWidget.prototype.getMapRadius=function(c){var a=this;if(a.map.getBounds()){var b=a.map.getBounds();return a.getBoundsDistance(b)/2}else{return 0}};WELOCALLY_PlacesMultiWidget.prototype.getBoundsDistance=function(a){var k=this;if(a){var c=a.getCenter();var e=a.getNorthEast();var b=6378.8;var g=c.lat()/57.2958;var j=c.lng()/57.2958;var f=e.lat()/57.2958;var h=e.lng()/57.2958;var d=b*Math.acos(Math.sin(g)*Math.sin(f)+Math.cos(g)*Math.cos(f)*Math.cos(h-j));return d}return 0};WELOCALLY_PlacesMultiWidget.prototype.setStatus=function(d,e,c,b){var a=this;jQuery(d).html("");jQuery(d).removeClass();jQuery(d).addClass(c);if(b){}jQuery(d).append("<em>"+e+"</em>");if(e!=""){jQuery(d).show()}else{jQuery(d).hide()}};WELOCALLY_PlacesMultiWidget.prototype.makeMapStatus=function(map,markers){var _instance=this;var status="";var radius=_instance.getMapRadius(_instance.map);if(markers!=null&&markers.length>1){status=status+" places found: "+eval(markers.length-1)}status=status+" search radius: "+radius.toFixed(2)+"km";status=status+" zoom: "+map.getZoom();return status};WELOCALLY_PlacesMultiWidget.prototype.getSelectedArea=function(){var a=this;return a.selectedSection};WELOCALLY_PlacesMultiWidget.prototype.getStatusArea=function(){var a=this;return a.mapStatus};WELOCALLY_PlacesMultiWidget.prototype.triggerResize=function(){var a=this;google.maps.event.trigger(a.map,"resize")};WELOCALLY_PlacesMultiWidget.prototype.show=function(a){jQuery(this.results).trigger("observerselected",{instance:this,type:observer,place:a},this.selectedItemHandler)};